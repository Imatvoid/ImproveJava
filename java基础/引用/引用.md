# java引用

## 问题

强引用、软引用、弱引用、幻象引用有什么区别？具体使用场景是什么？





## 引用的分类

**对象不同的可达性（reachable）状态和对垃圾收集的影响**。

实际上，Java中存在四种引用，它们由强到弱依次是：强引用、软引用、弱引用、虚引用。下面我们简单介绍下除弱引用外的其他三种引用：

- 强引用（Strong Reference）：豁免垃圾回收,不可回收

  通常我们通过new来创建一个新对象时返回的引用就是一个强引用，若一个对象通							过一系列强引用可到达，它就是强可达的(strongly reachable)，那么它就不被回收.

- 软引用（Soft Reference）：一定程度的豁免,内存不足可回收

  软引用是一种相对强引用弱化一些的引用，可以让对象豁免一些垃圾收集，只有当JVM认为内存不足时，才会去试图回收软引用指向的对象。JVM会确保在抛出OutOfMemoryError之前，清理软引用指向的对象。**软引用通常用来实现内存敏感的缓存**，如果还有空闲内存，就可以暂时保留缓存，当内存不足时清理掉，这样就保证了使用缓存的同时，不会耗尽内存。

  软引用和弱引用的区别在于，若一个对象是弱引用可达，无论当前内存是否充足它都会被回收，而软引用可达的对象在内存不充足时才会被回收，因此软引用要比弱引用“强”一些

- 弱引用（WeakReference）:不豁免垃圾回收

  弱引用并不能使对象豁免垃圾收集，仅仅是提供一种访问在弱引用状态下对象的途径。这就可以用来构建一种没有特定约束的关系，比如，维护一种非强制性的映射关系，如果试图获取时对象还在，就使用它，否则重现实例化。它同样是很多缓存实现的选择。

- 虚引用/幻象引用（Phantom Reference）：虚引用是Java中最弱的引用，那么它弱到什么程度呢？它是如此脆弱以至于我们通过虚引用甚至无法获取到被引用的对象，幻象引用仅仅是提供了一种确保对象被finalize以后，做某些事情的机制,常见的有加入引用队列，比如，通常用来做所谓的Post-Mortem清理机制，Java平台自身Cleaner机制等，也有人利用幻象引用监控对象的创建和销毁。



## 实例排查

诊断MySQL connector-j驱动在特定模式下（useCompression=true）的内存泄漏问题，就需要我们理解怎么排查幻象引用的堆积问题。



###  弱引用

一个对象只被弱引用指向，则它会被回收，无论内存是否充足。

这可以让垃圾收集器帮助我们完成一些清理操作。

http://www.importnew.com/21206.html

https://www.ibm.com/developerworks/cn/java/j-jtp11225/index.html

https://droidyue.com/blog/2014/10/12/understanding-weakreference-in-java/



## 参考

http://www.kdgregory.com/index.php?page=java.refobj